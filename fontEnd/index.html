<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Websocket示例</title>
    <script src="http://localhost:3000/socket.io/socket.io.js"></script>
    <script src="./js/jquery.min.js"></script>
    <script src="./js/moment.min.js"></script>
    <link rel="stylesheet" href="./index.css" />

    <script>
      // 消息类型映射
      const MSG_TYPE = Object.freeze({
        user: 1,
        system: 2,
      });
      const BASE_URL = 'http://localhost:3000';
      /**
       * @功能描述: 聊天室类
       * @参数:
       * @返回值:
       */
      class ChatRoom {
        constructor() {
          this.chatData = [];
          this.userName = '';
          this.userContent = '';
        }
        fetchData = () =>
          $.ajax({
            url: `${BASE_URL}/chatData`,
            type: 'GET',
            // 若使用jsonp方法跨域
            // dataType: 'jsonp',
            async: false,
            success: function(result) {
              const chatData = result.data;
              this.chatData = chatData;
              const domArr =
                chatData && chatData.length > 0
                  ? chatData.map(item => {
                      const { time, userName, content, msgType } = item;
                      const timeString = moment(time).format('YYYY-MM-DD HH:mm:ss');
                      return msgType === MSG_TYPE.user
                        ? `<div class="chat-row">
            <div class="release-time">${timeString}</div>
            <div class="user-line">
              <div class="name-wrap"><span class="user-name">${userName}</span>说:</div>
              <div class="chat-word">${content}</div>
            </div>
          </div>`
                        : `<div class="system-message"><span class="user-name">${userName}</span>${content}</div>`;
                    })
                  : [];
              const domString = domArr.join('');
              $('.chat-row,.system-message').remove();
              $('.chat-list').append(domString);
            },
          });
      }
      /**
       * @功能描述: Websocket类
       * @参数:
       * @返回值:
       */
      class Websocket {
        constructor() {
          this.socket;
        }
        // 连接到服务器
        handleConnect(callback) {
          try {
            const _this = this;
            this.socket = io.connect(BASE_URL);
            this.socket.on('connect', function() {
              const userName = localStorage.getItem('chatRoom-userName');
              const userStatus = localStorage.getItem('chatRoom-userStatus');
              if (userName && userStatus !== 'online') {
                chatRoom.userName = userName;
                _this.handleSendSystemMessage(userName, 'online');
                $('#name-input').val(userName);
              }
              const scrollHeight = $('.chat-list').prop('scrollHeight');
              // 获取聊天室数据
              chatRoom.fetchData();
              $('.chat-list').scrollTop(scrollHeight, 1000);
            });
            this.socket.on('getMessage', function(data) {
              // 服务端收到信息回调
              callback(data);
            });
            this.socket.on('disconnect', function() {
              alert('服务器已断开连接');
              this.userName = '';
              this.userContent = '';
              this.socket = null;
            });
          } catch (err) {
            console.log('err: ', err);
            alert('服务器未启动!');
          }
        }
        // 断开服务器
        handleDisconnect() {
          if (this.socket) {
            this.socket.disconnect(true);
          } else {
            alert('还未连接到服务器！');
          }
        }
        // 点击发送内容给服务器
        handleSendMessage(content) {
          if (this.socket) {
            this.socket.emit('sendMessage', content);
          } else {
            alert('请先连接到服务器！');
          }
        }
        /**
         * @功能描述: 发送系统消息
         * @参数: @param userName:用户名 @param status:用户状态(online/offline)
         * @返回值:
         */
        handleSendSystemMessage(userName, status) {
          if (status === 'online') {
            this.handleSendMessage({
              userName,
              userContent: '加入了聊天室',
              msgType: MSG_TYPE.system,
            });
          } else {
            this.handleSendMessage({
              userName,
              userContent: '离开了聊天室',
              msgType: MSG_TYPE.system,
            });
          }
          localStorage.setItem('chatRoom-userStatus', status);
        }
      }

      const chatRoom = new ChatRoom();
      const websocket = new Websocket();

      // 连接服务器
      const handleConnect = content => {
        // 发送成功回调
        const callback = () => {
          const scrollHeight = $('.chat-list').prop('scrollHeight');
          // 获取聊天室数据
          chatRoom.fetchData();
          $('.chat-list').scrollTop(scrollHeight, 1000);
        };
        websocket.handleConnect(callback);
      };

      $(document).ready(function() {
        // 获取聊天室数据
        chatRoom.fetchData();
        // 连接至服务器
        handleConnect();
        $('#name-input').change(function() {
          chatRoom.userName = $(this).val();
          localStorage.setItem('chatRoom-userName', chatRoom.userName);
          if ($(this).val() !== '') {
            websocket.handleSendSystemMessage(chatRoom.userName, 'online');
          }
        });
        $('#word-input').change(function() {
          chatRoom.userContent = $(this).val();
        });
        $('#send-btn').click(function() {
          if (chatRoom.userName === '') {
            alert('请先输入昵称!');
            return;
          }
          if (chatRoom.userContent.trim() === '') {
            alert('发送内容不可为空!');
            return;
          }
          websocket.handleSendMessage({
            userName: chatRoom.userName,
            userContent: chatRoom.userContent,
          });
          $('#word-input').val('');
          chatRoom.userContent = '';
        });
      });
    </script>
  </head>
  <body>
    <div class="container">
      <div class="chat-wrap">
        <div class="chat-header">
          聊天室
        </div>
        <div class="chat-list"></div>
        <div class="send-bar">
          <div class="name-bar">
            <input id="name-input" placeholder="请输入昵称" />
            <button id="send-btn">发送</button>
          </div>
          <textarea id="word-input" placeholder="请输入要说的话"></textarea>
        </div>
      </div>
    </div>
  </body>
</html>
